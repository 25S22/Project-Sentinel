#!/bin/bash
set -e # Exit immediately if any command fails

echo "### STARTING WAZUH DEEP CLEAN, PURGE, AND FRESH INSTALLATION ###"

# --- PHASE 1: PURGE PACKAGES & FIX APT ---
echo "[+] Phase 1/5: Purging broken Wazuh packages..."
# 'purge' removes packages AND their system-wide configuration files.
apt-get purge -y wazuh-agent || echo "wazuh-agent not found or already purged. Continuing."
apt-get purge -y wazuh-manager || echo "wazuh-manager not found or already purged. Continuing."
echo "[+] Cleaning up APT..."
apt-get --fix-broken install -y
apt autoremove -y
apt-get clean

# --- PHASE 2: DEEP CLEAN THE FILESYSTEM (FAILSAFE) ---
echo "[+] Phase 2/5: Manually deleting all leftover Wazuh directories for a guaranteed clean slate..."
rm -rf /etc/wazuh-*
rm -rf /var/lib/wazuh-*
rm -rf /usr/share/wazuh-*
rm -rf /var/ossec

# --- PHASE 3: PREPARE SYSTEM ENVIRONMENT ---
echo "[+] Phase 3/5: Preparing system..."
echo "[+] Updating system packages..."
apt-get update && apt-get upgrade -y
echo "[+] Applying required kernel setting (vm.max_map_count)..."
sysctl -w vm.max_map_count=262144
echo "vm.max_map_count=262144" | tee -a /etc/sysctl.conf

# --- PHASE 4: FRESH WAZUH INSTALLATION ---
echo "[+] Phase 4/5: Starting fresh Wazuh installation..."
rm -f ./wazuh-install.sh* # Remove old installer script if it exists
curl -sO https://packages.wazuh.com/4.7/wazuh-install.sh
bash ./wazuh-install.sh -a -i

# --- PHASE 5: VERIFICATION AND FINALIZATION ---
echo "[+] Phase 5/5: Verifying installation and enabling services..."
echo "[+] Enabling services to start on boot..."
systemctl enable wazuh-indexer
systemctl enable wazuh-manager
systemctl enable filebeat
systemctl enable wazuh-agent

echo "[+] Checking service statuses..."
systemctl is-active --quiet wazuh-indexer && echo "Wazuh Indexer is RUNNING." || (echo "ERROR: Wazuh Indexer failed to start." && exit 1)
systemctl is-active --quiet wazuh-manager && echo "Wazuh Manager is RUNNING." || (echo "ERROR: Wazuh Manager failed to start." && exit 1)
systemctl is-active --quiet filebeat && echo "Filebeat is RUNNING." || (echo "ERROR: Filebeat failed to start." && exit 1)
systemctl is-active --quiet wazuh-agent && echo "Wazuh Agent is RUNNING." || (echo "ERROR: Wazuh Agent failed to start." && exit 1)

echo "[+] Verifying local agent connection..."
/var/ossec/bin/agent_control -l

echo "### INSTALLATION COMPLETE ###"
echo "Your Wazuh admin password is:"
grep -oP 'admin_password: \K\w+' wazuh-install-files/wazuh-passwords.txt
echo "Access the dashboard at https://<your_ip>"
